<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi tiết từ: Example - Wordee</title>

    <link rel="stylesheet" href="/css/word_detail.css">
    <link rel="stylesheet" href="/css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <header id="header">
        <div class="header-left">
            <div class="logo">
                <a href="index.html">Wordee</a>
            </div>
            <nav class="main-nav">
                <a href="word_list.html">Từ vựng</a>
                <a href="album.html" class="private-link">Bộ từ vựng</a>
                <a href="practice_list.html" class="private-link">Luyện tập</a>
            </nav>
        </div>
        <div class="header-right">
            
            <div class="auth-buttons">
                <a href="login.html" class="btn-login">Đăng nhập</a>
                <a href="signup.html" class="btn-signup">Đăng ký</a>
            </div>
        </div>
    </header>

    <main id="content">
        <div class="word-container" id="word-detail-container">
            <p style="text-align: center; padding: 2rem;">Đang tải chi tiết từ...</p>
        </div>

        <!-- Form chọn bộ từ vựng -->
        <div id="add-to-album-modal" class="form-modal-overlay" style="display: none;">
            <div class="form-modal-content">
                <h2>Thêm từ vào bộ từ vựng</h2>
                <p id="add-to-album-error" class="form-error-text"></p>
                
                <p>Chọn một bộ từ vựng để thêm từ:</p>
                
                <div id="album-select-list" class="form-album-select-list">
                    <p>Đang tải...</p>
                </div>
                
                <div class="form-modal-actions">
                    <button type="button" id="cancel-add-btn" class="form-btn-cancel">Hủy</button>
                    <button type="button" id="save-to-album-btn" class="form-btn-submit">Lưu</button>
                </div>
            </div>
        </div>

    </main>

    <footer id="footer">
        <div class="footer-content">
            <div class="footer-about">
                <h3>Wordee</h3>
                <p>Trang web từ điển Anh-Việt, giúp bạn học tập và tra cứu từ vựng một cách hiệu quả nhất.</p>
            </div>
            <div class="footer-links">
                <h4>Liên kết nhanh</h4>
                <ul>
                    <li><a href="index.html">Trang chủ</a></li>
                    <li><a href="word_list.html">Từ vựng</a></li>
                    <li><a href="album.html">Bộ từ vựng</a></li>
                    <li><a href="login.html">Đăng nhập</a></li>
                    <li><a href="signup.html">Đăng ký</a></li>
                </ul>
            </div>
            <div class="footer-contact">
                <h4>Liên hệ</h4>
                <p>Email: support@wordee.com</p>
                <p>Hotline: 1900 1234</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Wordee. Phát triển bởi bạn.</p>
        </div>
    </footer>

    <script src="../js/auth.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const detailContainer = document.getElementById('word-detail-container');

            // 1. Lấy tên từ từ URL (ví dụ: ?word=Apple)
            const urlParams = new URLSearchParams(window.location.search);
            const wordName = urlParams.get('word');

            // === CÁC BIẾN CHO MODAL ===
            const token = localStorage.getItem('token');
            const addToAlbumModal = document.getElementById('add-to-album-modal');
            const albumSelectList = document.getElementById('album-select-list');
            const saveToAlbumBtn = document.getElementById('save-to-album-btn');
            const cancelAddBtn = document.getElementById('cancel-add-btn');
            const addToAlbumError = document.getElementById('add-to-album-error');

            if (!wordName) {
                detailContainer.innerHTML = '<h1>Lỗi</h1><p>Không có từ nào được chỉ định để tra cứu.</p>';
                return;
            }

            // 2. Hàm Fetch API
            async function fetchWordDetails() {
                try {
                    // Gọi API ta vừa tạo: /api/words/Apple
                    const response = await fetch(`/api/words/${wordName}`);

                    if (response.status === 404) {
                        detailContainer.innerHTML = `<h1>Không tìm thấy</h1><p>Không tìm thấy từ vựng: <strong>${wordName}</strong> trong từ điển.</p>`;
                        return;
                    }
                    if (!response.ok) {
                        throw new Error('Lỗi server');
                    }

                    const word = await response.json(); // Lấy đối tượng từ vựng

                    // 3. VẼ HTML (Sử dụng code layout cũ của bạn)
                    detailContainer.innerHTML = `
                        <div class="word-header">
                            <div class="word-top-line">
                                <h1 class="word-title">${word.word}</h1>
                                <button class="audio-btn" aria-label="Nghe phát âm">
                                    <i class="fas fa-volume-up"></i>
                                </button>
                            </div>
                            <span class="word-pronunciation">${word.pronunciation || 'N/A'}</span>
                            <span class="word-translation">${word.translation.split(';')[0]}</span>
                        </div>

                        <div class="word-actions">
                            <button class="add-to-album-btn" data-word-id="${word._id}">
                                <i class="fas fa-plus"></i> Thêm vào bộ từ
                            </button>
                            <span class="word-category">Chủ đề: ${word.category}</span>
                        </div>

                        <div class="word-body">
                            <section class="definition-block">
                                <span class="word-type">${word.type}</span>
                                <ol class="definition-list">
                                    <li>
                                        <p class="definition-vi-text">${word.translation}</p>
                                        
                                        ${word.example_en ? `
                                        <div class="example-group">
                                            <p class="example-en"><i>Ví dụ: "${word.example_en}"</i></p>
                                            <p class="example-vi"><i>(Dịch: ${word.example_vi || '...'})</i></p>
                                        </div>
                                        ` : ''}
                                    </li>
                                </ol>
                            </section>
                        </div>
                    `;

                } catch (err) {
                    console.error('Lỗi khi tải chi tiết từ:', err);
                    detailContainer.innerHTML = `<h1>Lỗi mạng</h1><p>Không thể kết nối đến server để tải từ.</p>`;
                }
            }

            // === SỬA LẠI: HÀM SỰ KIỆN CLICK (Gộp Audio và Thêm từ) ===
            detailContainer.addEventListener('click', async (event) => {
                // 1. Xử lý nút Audio (code cũ của bạn)
                const audioButton = event.target.closest('.audio-btn');
                if (audioButton) {
                    const wordItem = audioButton.closest('.word-header');
                    const wordToSpeak = wordItem.querySelector('.word-title').innerText;
                    
                    if (wordToSpeak && 'speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(wordToSpeak);
                        utterance.lang = 'en-US'; 
                        utterance.rate = 0.9;
                        window.speechSynthesis.speak(utterance);
                    }
                    return; // Dừng lại
                }

                // 2. Xử lý nút "Thêm vào bộ từ" (code mới)
                const addButton = event.target.closest('.add-to-album-btn');
                if (addButton) {
                    if (!token) {
                        alert('Vui lòng đăng nhập để sử dụng chức năng này.');
                        window.location.href = 'login.html';
                        return;
                    }
                    const wordId = addButton.dataset.wordId;
                    saveToAlbumBtn.dataset.wordId = wordId; // Gán wordId vào nút "Lưu"

                    await loadAlbumsForModal();
                    addToAlbumModal.style.display = 'flex'; // Hiển thị modal
                }
            });

            // === HÀM MỚI: TẢI DANH SÁCH ALBUM ===
            async function loadAlbumsForModal() {
                albumSelectList.innerHTML = '<p>Đang tải bộ từ vựng...</p>';
                addToAlbumError.textContent = '';
                saveToAlbumBtn.disabled = true;

                try {
                    const res = await fetch('/api/albums', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message);
                    
                    if (data.results === 0) {
                        albumSelectList.innerHTML = '<p>Bạn chưa có bộ từ nào. <a href="album.html" target="_blank">Tạo bộ từ mới?</a></p>';
                    } else {
                        albumSelectList.innerHTML = data.data.map((album, index) => `
                            <div class="form-album-select-option">
                                <input type="radio" name="album-select" id="album-${album._id}" value="${album._id}" ${index === 0 ? 'checked' : ''}>
                                <label for="album-${album._id}">${album.title} (${album.words.length} từ)</label>
                            </div>
                        `).join('');
                        saveToAlbumBtn.disabled = false;
                    }
                } catch (err) {
                    albumSelectList.innerHTML = `<p style="color: red;">Lỗi tải album: ${err.message}</p>`;
                }
            }

            // === HÀM MỚI: THỰC THI LƯU TỪ VÀO ALBUM ===
            async function executeSaveToAlbum() {
                const wordId = saveToAlbumBtn.dataset.wordId;
                const selectedAlbumRadio = albumSelectList.querySelector('input[name="album-select"]:checked');
                
                if (!selectedAlbumRadio) {
                    addToAlbumError.textContent = 'Bạn chưa chọn bộ từ nào.';
                    return;
                }
                
                const albumId = selectedAlbumRadio.value;
                addToAlbumError.textContent = '';

                try {
                    const res = await fetch(`/api/albums/${albumId}/words`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ wordId: wordId })
                    });
                    
                    const data = await res.json();
                    
                    if (res.ok) {
                        alert('Đã thêm từ vào bộ từ vựng thành công!');
                        addToAlbumModal.style.display = 'none';
                    } else {
                        throw new Error(data.message);
                    }
                } catch (err) {
                    addToAlbumError.textContent = err.message;
                }
            }

            // === GÁN SỰ KIỆN MỚI CHO NÚT CỦA MODAL ===
            cancelAddBtn.addEventListener('click', () => addToAlbumModal.style.display = 'none');
            saveToAlbumBtn.addEventListener('click', executeSaveToAlbum);

            // Chạy hàm tải từ
            fetchWordDetails();
        });
    </script>
</body>

</html>