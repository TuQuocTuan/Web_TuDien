<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách từ vựng - Wordee</title>

    <link rel="stylesheet" href="../css/word_list.css">
    <link rel="stylesheet" href="/css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>

<body>

    <header id="header">
        <div class="header-left">
            <div class="logo">
                <a href="index.html">Wordee</a>
            </div>
            <nav class="main-nav">
                <a href="word_list.html" class="active">Từ vựng</a>
                <a href="album.html" class="private-link">Bộ từ vựng</a>
                <a href="practice_list.html" class="private-link">Luyện tập</a>
            </nav>
        </div>
        <div class="header-right">
            <div class="timkiem">
                <input type="search" name="thanhtimkiem" id="thanhtimkiem" placeholder="Tìm kiếm từ...">
                <button type="submit"><i class="fas fa-search"></i></button>
            </div>
            <div class="auth-buttons">
                <a href="login.html" class="btn-login">Đăng nhập</a>
                <a href="signup.html" class="btn-signup">Đăng ký</a>
            </div>
        </div>
    </header>

    <main id="content">
        <div class="vocab-layout-container">

            <aside class="filter-sidebar">
                <h3><i class="fas fa-filter"></i> Bộ lọc</h3>

                <div class="filter-group">
                    <h4>Loại từ (Part of Speech)</h4>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-all" name="filter-type" value="all" checked>
                        <label for="filter-all">Tất cả (All)</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-noun" name="filter-type" value="noun">
                        <label for="filter-noun">Danh từ (Noun)</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-verb" name="filter-type" value="verb">
                        <label for="filter-verb">Động từ (Verb)</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-adj" name="filter-type" value="adjective">
                        <label for="filter-adj">Tính từ (Adjective)</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-adv" name="filter-type" value="adverb">
                        <label for="filter-adv">Trạng từ (Adverb)</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-pre" name="filter-type" value="preposition">
                        <label for="filter-pre">Giới từ (Preposition)</label>
                    </div>
                </div>

                <div class="filter-group">
                    <h4>Chủ đề (Topic)</h4>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-school" name="filter-topic" value="school">
                        <label for="filter-school">Trường học</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-science" name="filter-topic" value="science">
                        <label for="filter-science">Khoa học</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-cooking" name="filter-topic" value="cooking">
                        <label for="filter-cooking">Nấu ăn</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-entertainment" name="filter-topic" value="entertainment">
                        <label for="filter-entertainment">Giải trí</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-music" name="filter-topic" value="music">
                        <label for="filter-music">Âm nhạc</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-travel" name="filter-topic" value="travel">
                        <label for="filter-travel">Du lịch</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-friends" name="filter-topic" value="friends">
                        <label for="filter-friends">Bạn bè</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-sports" name="filter-topic" value="sports">
                        <label for="filter-sports">Thể thao</label>
                    </div>
                    <div class="filter-option">
                        <input type="checkbox" id="filter-health" name="filter-topic" value="health">
                        <label for="filter-health">Y tế</label>
                    </div>
                </div>

            </aside>
            <section class="vocab-list-section">

                <div class="sort-bar">
                    <label for="sort-select">Sắp xếp theo:</label>
                    <select id="sort-select" name="sort-by">
                        <option value="alphabetical_asc">Thứ tự A-Z</option>
                        <option value="alphabetical_desc">Thứ tự Z-A</option>
                    </select>
                </div>

                <div class="vocab-list" id="vocab-list-container">
                    <p>Đang tải từ vựng...</p>
                </div>

                <nav class="pagination">
                    <a href="#" class="page-link disabled"><i class="fas fa-angle-left"></i></a>
                    <a href="#" class="page-link active">1</a>
                    <a href="#" class="page-link">2</a>
                    <a href="#" class="page-link">3</a>
                    <span class="page-link dots">...</span>
                    <a href="#" class="page-link">10</a>
                    <a href="#" class="page-link"><i class="fas fa-angle-right"></i></a>
                </nav>
            </section>
        </div>
    </main>

    <footer id="footer">
        <div class="footer-content">
            <div class="footer-about">
                <h3>Wordee</h3>
                <p>Trang web từ điển Anh-Việt, giúp bạn học tập và tra cứu từ vựng một cách hiệu quả nhất.</p>
            </div>
            <div class="footer-links">
                <h4>Liên kết nhanh</h4>
                <ul>
                    <li><a href="index.html">Trang chủ</a></li>
                    <li><a href="word_list.html">Từ vựng</a></li>
                    <li><a href="album.html">Bộ từ vựng</a></li>
                    <li><a href="login.html">Đăng nhập</a></li>
                    <li><a href="signup.html">Đăng ký</a></li>
                </ul>
            </div>
            <div class="footer-contact">
                <h4>Liên hệ</h4>
                <p>Email: support@wordee.com</p>
                <p>Hotline: 1900 1234</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Wordee. Phát triển bởi bạn.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Lấy các phần tử HTML
            const vocabListContainer = document.getElementById('vocab-list-container');
            const allFilterCheckboxes = document.querySelectorAll('.filter-sidebar input[type="checkbox"]');
            const typeFilterAll = document.getElementById('filter-all');
            const sortSelectEl = document.getElementById('sort-select');
            const searchInputEl = document.getElementById('thanhtimkiem');
            const paginationContainer = document.querySelector('.pagination');

            // Đọc URL (Giữ nguyên)
            const urlParams = new URLSearchParams(window.location.search);
            const searchFromURL = urlParams.get('search');
            if (searchFromURL) {
                searchInputEl.value = searchFromURL;
            }

            // HÀM 1: "Vẽ" HTML (Giữ nguyên)
            function renderWords(words) {
                // ... (Code renderWords của bạn y hệt như cũ) ...
                vocabListContainer.innerHTML = '';
                if (words.length === 0) {
                    vocabListContainer.innerHTML = '<p style="padding: 1rem;">Không tìm thấy từ vựng nào.</p>';
                    return;
                }
                words.forEach(word => {
                    const wordItem = document.createElement('div');
                    wordItem.className = 'vocab-item';
                    const typeClass = word.type.toLowerCase();
                    wordItem.innerHTML = `
                        <div class="item-main">
                            <a href="word_detail.html?word=${word.word}" class="item-word">${word.word}</a>
                            <span class="item-pronunciation">${word.pronunciation || ''}</span>
                        </div>
                        <div class="item-info">
                            <span class="item-type ${typeClass}">${word.type}</span>
                            <p class="item-definition">${word.translation}</p>
                        </div>
                        <div class="item-actions">
                            <button class="action-btn add" aria-label="Thêm vào bộ từ" data-word-id="${word._id}">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button class="action-btn audio" aria-label="Nghe">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                    `;
                    vocabListContainer.appendChild(wordItem);
                });
            }

            // HÀM 2: VẼ PHÂN TRANG (Giữ nguyên)
            function renderPagination(totalPages, currentPage) {
                // ... (Code renderPagination của bạn y hệt như cũ) ...
                paginationContainer.innerHTML = '';
                if (totalPages <= 1) return;

                const prevButton = createPageLink('<i class="fas fa-angle-left"></i>', currentPage - 1);
                if (currentPage === 1) prevButton.classList.add('disabled');
                paginationContainer.appendChild(prevButton);

                const pagesToShow = new Set();
                pagesToShow.add(1);
                pagesToShow.add(totalPages);
                pagesToShow.add(currentPage);
                if (currentPage > 1) pagesToShow.add(currentPage - 1);
                if (currentPage < totalPages) pagesToShow.add(currentPage + 1);
                if (currentPage > 3) pagesToShow.add(currentPage - 2);
                if (currentPage < totalPages - 2) pagesToShow.add(currentPage + 2);

                const sortedPages = Array.from(pagesToShow).sort((a, b) => a - b);

                let lastPage = 0;
                sortedPages.forEach(page => {
                    if (lastPage !== 0 && page - lastPage > 1) {
                        paginationContainer.appendChild(createPageLink('...', null, true));
                    }
                    paginationContainer.appendChild(createPageLink(page, page, false, currentPage));
                    lastPage = page;
                });

                const nextButton = createPageLink('<i class="fas fa-angle-right"></i>', currentPage + 1);
                if (currentPage === totalPages) nextButton.classList.add('disabled');
                paginationContainer.appendChild(nextButton);
            }

            // HÀM 3: HÀM TẠO NÚT (Giữ nguyên)
            function createPageLink(pageText, pageNumber, isDots = false, currentPage = 0) {
                // ... (Code createPageLink của bạn y hệt như cũ) ...
                const pageLink = document.createElement('a');
                pageLink.href = '#';
                pageLink.className = 'page-link';
                pageLink.innerHTML = pageText;
                if (isDots) {
                    pageLink.classList.add('dots');
                } else {
                    if (pageNumber === currentPage) {
                        pageLink.classList.add('active');
                    }
                    pageLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (pageNumber) fetchAndRenderWords(pageNumber);
                    });
                }
                return pageLink;
            }

            // =================================
            // ===== HÀM 4: GẮN LOGIC PHÁT ÂM (MỚI) =====
            // =================================
            function attachAudioListeners() {
                // Lấy TẤT CẢ các nút audio vừa được vẽ ra
                const audioButtons = document.querySelectorAll('.action-btn.audio');

                audioButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        // Tìm '.vocab-item' (cái thẻ cha) gần nhất
                        const wordItem = e.currentTarget.closest('.vocab-item');
                        if (wordItem) {
                            // Tìm từ Tiếng Anh trong thẻ đó
                            const word = wordItem.querySelector('.item-word').textContent;
                            if (word) {
                                // Sử dụng API có sẵn của trình duyệt để phát âm
                                const utterance = new SpeechSynthesisUtterance(word);
                                utterance.lang = 'en-US'; // Đặt ngôn ngữ là Anh-Mỹ
                                window.speechSynthesis.speak(utterance);
                            }
                        }
                    });
                });
            }

            // HÀM 5: Lấy dữ liệu từ API (ĐÃ SỬA)
            async function fetchAndRenderWords(page = 1) {
                // ... (Code logic lấy filter, sort, search của bạn) ...
                const currentSortBy = sortSelectEl.value;
                const searchQuery = searchInputEl.value.trim();
                const filters = { type: [], category: [] };
                allFilterCheckboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        if (checkbox.name === 'filter-type' && checkbox.value !== 'all') filters.type.push(checkbox.value);
                        if (checkbox.name === 'filter-topic') filters.category.push(checkbox.value);
                    }
                });
                const queryParts = [];
                if (searchQuery) queryParts.push(`search=${encodeURIComponent(searchQuery)}`);
                if (filters.type.length > 0) queryParts.push(`type=${filters.type.join(',')}`);
                if (filters.category.length > 0) queryParts.push(`category=${filters.category.join(',')}`);
                queryParts.push(`sort=${currentSortBy}`);
                queryParts.push(`page=${page}`);
                let queryString = `?${queryParts.join('&')}`;

                // Gọi API
                try {
                    vocabListContainer.innerHTML = '<p>Đang tải từ vựng...</p>';
                    const response = await fetch(`/api/words${queryString}`);
                    if (!response.ok) throw new Error('Lỗi mạng');

                    const data = await response.json();

                    renderWords(data.words); // Vẽ 5 từ
                    renderPagination(data.totalPages, data.currentPage); // Vẽ nút 1, 2, 3...

                    // ===== GỌI HÀM PHÁT ÂM SAU KHI VẼ XONG =====
                    attachAudioListeners();

                } catch (err) {
                    console.error('Lỗi khi tải từ:', err);
                    vocabListContainer.innerHTML = '<p style="padding: 1rem; color: red;">Lỗi tải từ vựng.</p>';
                }
            }

            // HÀM 6: Xử lý nút "Tất cả" (Giữ nguyên)
            function handleFilterAllLogic(changedCheckbox) {
                // ... (code xử lý nút "Tất cả" của bạn) ...
                if (changedCheckbox.id === 'filter-all' && changedCheckbox.checked) {
                    allFilterCheckboxes.forEach(cb => {
                        if (cb.name === 'filter-type' && cb.id !== 'filter-all') cb.checked = false;
                    });
                } else if (changedCheckbox.name === 'filter-type' && changedCheckbox.id !== 'filter-all') {
                    typeFilterAll.checked = false;
                }
                fetchAndRenderWords(1);
            }

            // Gắn "tai" cho TẤT CẢ các bộ lọc
            allFilterCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => handleFilterAllLogic(checkbox));
            });
            sortSelectEl.addEventListener('change', () => fetchAndRenderWords(1));
            searchInputEl.addEventListener('input', () => fetchAndRenderWords(1));

            // Tải danh sách lần đầu (trang 1)
            fetchAndRenderWords(1);
        });
    </script>
    <script src="../js/auth.js"></script>
</body>

</html>