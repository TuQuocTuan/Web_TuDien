<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách từ vựng - Wordee</title>

    <link rel="stylesheet" href="../css/word_list.css">
    <link rel="stylesheet" href="/css/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

</head>

<body>

    <header id="header">
        <div class="header-left">
            <div class="logo">
                <a href="index.html">Wordee</a>
            </div>
            <nav class="main-nav">
                <a href="word_list.html" class="active">Từ vựng</a>
                <a href="album.html" class="private-link">Bộ từ vựng</a>
                <a href="practice_list.html" class="private-link">Luyện tập</a>
            </nav>
        </div>
        <div class="header-right">
            <div class="timkiem">
                <input type="search" name="thanhtimkiem" id="thanhtimkiem" placeholder="Tìm kiếm từ...">
                <button type="submit"><i class="fas fa-search"></i></button>
            </div>
            <div class="auth-buttons">
                <a href="login.html" class="btn-login">Đăng nhập</a>
                <a href="signup.html" class="btn-signup">Đăng ký</a>
            </div>
        </div>
    </header>

    <main id="content">
        <div class="vocab-layout-container">

            <aside class="filter-sidebar">
                <h3><i class="fas fa-filter"></i> Bộ lọc</h3>

                <div class="filter-group">
                    <h4>Loại từ (Part of Speech)</h4>

                    <div class="filter-option">
                        <input type="radio" id="filter-all" name="filter-type" value="all" checked>
                        <label for="filter-all">Tất cả (All)</label>
                    </div>
                    <div class="filter-option">
                        <input type="radio" id="filter-noun" name="filter-type" value="danh từ">
                        <label for="filter-noun">Danh từ (Noun)</label>
                    </div>
                    <div class="filter-option">
                        <input type="radio" id="filter-verb" name="filter-type" value="động từ">
                        <label for="filter-verb">Động từ (Verb)</label>
                    </div>
                    <div class="filter-option">
                        <input type="radio" id="filter-adj" name="filter-type" value="tính từ">
                        <label for="filter-adj">Tính từ (Adjective)</label>
                    </div>
                    <div class="filter-option">
                        <input type="radio" id="filter-adv" name="filter-type" value="trạng từ">
                        <label for="filter-adv">Trạng từ (Adverb)</label>
                    </div>
                    <div class="filter-option">
                        <input type="radio" id="filter-pre" name="filter-type" value="giới từ">
                        <label for="filter-pre">Giới từ (Preposition)</label>
                    </div>

                </div>

            </aside>

            <section class="vocab-list-section">

                <div class="sort-bar">
                    <label for="sort-select">Sắp xếp theo:</label>
                    <select id="sort-select" name="sort-by">
                        <option value="alphabetical_asc">Thứ tự A-Z</option>
                        <option value="alphabetical_desc">Thứ tự Z-A</option>
                    </select>
                </div>

                <div class="vocab-list" id="vocab-list-container">
                    <p>Đang tải từ vựng...</p>
                </div>

                <nav class="pagination">
                    <a href="#" class="page-link disabled"><i class="fas fa-angle-left"></i></a>
                    <a href="#" class="page-link active">1</a>
                    <a href="#" class="page-link">2</a>
                    <a href="#" class="page-link">3</a>
                    <span class="page-link dots">...</span>
                    <a href="#" class="page-link">10</a>
                    <a href="#" class="page-link"><i class="fas fa-angle-right"></i></a>
                </nav>
            </section>
        </div>
    </main>

    <footer id="footer">
        <div class="footer-content">
            <div class="footer-about">
                <h3>Wordee</h3>
                <p>Trang web từ điển Anh-Việt, giúp bạn học tập và tra cứu từ vựng một cách hiệu quả nhất.</p>
            </div>
            <div class="footer-links">
                <h4>Liên kết nhanh</h4>
                <ul>
                    <li><a href="index.html">Trang chủ</a></li>
                    <li><a href="word_list.html">Từ vựng</a></li>
                    <li><a href="album.html">Bộ từ vựng</a></li>
                    <li><a href="login.html">Đăng nhập</a></li>
                    <li><a href="signup.html">Đăng ký</a></li>
                </ul>
            </div>
            <div class="footer-contact">
                <h4>Liên hệ</h4>
                <p>Email: support@wordee.com</p>
                <p>Hotline: 1900 1234</p>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2025 Wordee. Phát triển bởi bạn.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Lấy các phần tử HTML
            const vocabListContainer = document.getElementById('vocab-list-container');
            const allFilterRadios = document.querySelectorAll('.filter-sidebar input[type="radio"]'); // Sửa (Checkbox -> Radio)
            const typeFilterAll = document.getElementById('filter-all'); // Nút "Tất cả"
            const sortSelectEl = document.getElementById('sort-select');
            const searchInputEl = document.getElementById('thanhtimkiem');
            const paginationContainer = document.querySelector('.pagination');

            // BẢNG DỊCH LOẠI TỪ (Sửa lỗi CSS)
            const typeTranslationMap = {
                'danh từ': 'noun',
                'động từ': 'verb',
                'tính từ': 'adjective',
                'trạng từ': 'adverb',
                'phó từ': 'adverb',
                'giới từ': 'preposition',
                'mạo từ': 'article',
                'thán từ': 'interjection'
            };

            // ĐỌC URL (Khi chuyển từ trang chủ)
            const urlParams = new URLSearchParams(window.location.search);
            const searchFromURL = urlParams.get('search');
            if (searchFromURL) {
                searchInputEl.value = searchFromURL;
            }

            // HÀM 1: "Vẽ" HTML (Sửa lỗi CSS)
            function renderWords(words) {
                vocabListContainer.innerHTML = '';
                if (words.length === 0) {
                    vocabListContainer.innerHTML = '<p style="padding: 1rem;">Không tìm thấy từ vựng nào.</p>';
                    return;
                }
                words.forEach(word => {
                    const wordItem = document.createElement('div');
                    wordItem.className = 'vocab-item';

                    let typeText = word.type || ''; // Lấy "danh từ"
                    let typeClass = 'default';
                    if (typeText) {
                        typeClass = typeTranslationMap[typeText.toLowerCase()] || 'default'; // Dịch sang "noun"
                    }

                    wordItem.innerHTML = `
<div class="item-main">
<a href="word_detail.html?word=${word.word}" class="item-word">${word.word}</a>
 <span class="item-pronunciation">${word.pronunciation || ''}</span>
</div>
 <div class="item-info">
                        <span class="item-type ${typeClass}">${typeText}</span>
                <p class="item-definition">${word.translation}</p>
                </div>
                <div class="item-actions">
                <button class="action-btn add" aria-label="Thêm vào bộ từ" data-word-id="${word._id}">
                <i class="fas fa-plus"></i>
                </button>
                <button class="action-btn audio" aria-label="Nghe">
                <i class="fas fa-volume-up"></i>
                </button>
                </div>
                `;
                    vocabListContainer.appendChild(wordItem);
                });
            }

            // HÀM 2: VẼ PHÂN TRANG (PAGINATION)
            function renderPagination(totalPages, currentPage) {
                paginationContainer.innerHTML = '';
                if (totalPages <= 1) return;
                const prevButton = createPageLink('<i class="fas fa-angle-left"></i>', currentPage - 1);
                if (currentPage === 1) prevButton.classList.add('disabled');
                paginationContainer.appendChild(prevButton);
                const pagesToShow = new Set();
                pagesToShow.add(1);
                pagesToShow.add(totalPages);
                pagesToShow.add(currentPage);
                if (currentPage > 1) pagesToShow.add(currentPage - 1);
                if (currentPage < totalPages) pagesToShow.add(currentPage + 1);
                if (currentPage > 3) pagesToShow.add(currentPage - 2);
                if (currentPage < totalPages - 2) pagesToShow.add(currentPage + 2);
                const sortedPages = Array.from(pagesToShow).sort((a, b) => a - b);
                let lastPage = 0;
                sortedPages.forEach(page => {
                    if (lastPage !== 0 && page - lastPage > 1) {
                        paginationContainer.appendChild(createPageLink('...', null, true));
                    }
                    paginationContainer.appendChild(createPageLink(page, page, false, currentPage));
                    lastPage = page;
                });
                const nextButton = createPageLink('<i class="fas fa-angle-right"></i>', currentPage + 1);
                if (currentPage === totalPages) nextButton.classList.add('disabled');
                paginationContainer.appendChild(nextButton);
            }

            // HÀM 3: HÀM TẠO NÚT
            function createPageLink(pageText, pageNumber, isDots = false, currentPage = 0) {
                const pageLink = document.createElement('a');
                pageLink.href = '#';
                pageLink.className = 'page-link';
                pageLink.innerHTML = pageText;
                if (isDots) {
                    pageLink.classList.add('dots');
                } else {
                    if (pageNumber === currentPage) {
                        pageLink.classList.add('active');
                    }
                    pageLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (pageNumber) fetchAndRenderWords(pageNumber);
                    });
                }
                return pageLink;
            }

            // HÀM 4: GẮN LOGIC PHÁT ÂM (AUDIO)
            function attachAudioListeners() {
                const audioButtons = document.querySelectorAll('.action-btn.audio');
                audioButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const wordItem = e.currentTarget.closest('.vocab-item');
                        if (wordItem) {
                            const word = wordItem.querySelector('.item-word').textContent;
                            if (word) {
                                const utterance = new SpeechSynthesisUtterance(word);
                                utterance.lang = 'en-US';
                                window.speechSynthesis.speak(utterance);
                            }
                        }
                    });
                });
            }

            // HÀM 5: LẤY DỮ LIỆU TỪ API (Hàm chính - Đã sửa lỗi)
            async function fetchAndRenderWords(page = 1) {
                const currentSortBy = sortSelectEl.value;
                const searchQuery = searchInputEl.value.trim();

                const queryParts = [];
                if (searchQuery) queryParts.push(`search=${encodeURIComponent(searchQuery)}`);

                // Lấy giá trị filter (Radio)
                let typeFilter = '';
                allFilterRadios.forEach(radio => {
                    if (radio.checked && radio.value !== 'all') {
                        typeFilter = radio.value;
                    }
                });
                if (typeFilter) {
                    queryParts.push(`type=${typeFilter}`);
                }

                queryParts.push(`sort=${currentSortBy}`);
                queryParts.push(`page=${page}`);

                let queryString = `?${queryParts.join('&')}`;

                // Gọi API
                try {
                    vocabListContainer.innerHTML = '<p>Đang tải từ vựng...</p>';
                    const response = await fetch(`/api/words${queryString}`);
                    if (!response.ok) throw new Error('Lỗi mạng');

                    const data = await response.json();

                    renderWords(data.words);
                    renderPagination(data.totalPages, data.currentPage);
                    attachAudioListeners();

                } catch (err) {
                    console.error('Lỗi khi tải từ:', err);
                    vocabListContainer.innerHTML = '<p style="padding: 1rem; color: red;">Lỗi tải từ vựng.</p>';
                }
            }

            // HÀM 6: Xử lý nút "Tất cả" (ĐÃ BỊ XÓA - Không cần nữa)

            // Gắn "tai" cho TẤT CẢ các bộ lọc
            allFilterRadios.forEach(radio => {
                radio.addEventListener('change', () => fetchAndRenderWords(1));
            });
            sortSelectEl.addEventListener('change', () => fetchAndRenderWords(1));
            searchInputEl.addEventListener('input', () => fetchAndRenderWords(1));

            // Tải danh sách lần đầu (trang 1)
            fetchAndRenderWords(1);
        });
    </script>
    <script src="../js/auth.js"></script>
</body>

</html>